<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sree Sasatha Seva Sangam</title>
<style>
  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:16px; display:flex; justify-content:center; }
  .wrap { width:100%; max-width:720px; }
  .header { background:#d2b48c; padding:18px; text-align:center; color:#4b2e15; font-weight:700; border-bottom:3px solid #b88a57; border-radius:8px; }
  .card { background:white; border-radius:10px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-top:12px; }
  label { font-weight:600; font-size:14px; display:block; margin-top:10px; margin-bottom:6px; }
  input, select { width:100%; padding:10px; border-radius:8px; border:1px solid #cfcfcf; font-size:15px; box-sizing:border-box; }
  .row { display:flex; gap:10px; margin-top:6px; }
  .col { flex:1; }
  .payment-box { display:flex; justify-content:space-around; align-items:center; gap:10px; padding:10px; border-radius:8px; margin-top:6px; background:#f3e5d8; border:2px solid #b88a57; }
  .payment-option { display:flex; align-items:center; gap:6px; font-size:15px; }
  .controls { display:flex; gap:10px; margin-top:12px; align-items:center; flex-wrap:wrap; }
  .btn { padding:12px 16px; border-radius:8px; border:none; background:#0066cc; color:#fff; font-weight:700; font-size:15px; cursor:pointer; }
  .btn:disabled { opacity:0.6; cursor:not-allowed; }
  .summary { display:flex; justify-content:space-between; gap:10px; margin-top:12px; }
  .summary .box { flex:1; padding:10px; border-radius:8px; background:#fff6ea; border:1px solid #f0d9b4; text-align:center; }
  table { width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; }
  th, td { padding:8px; border:1px solid #eee; text-align:left; vertical-align:top; }
  th { background:#fafafa; font-weight:700; }
  .center { text-align:center; }
  .loader { display:inline-block; width:18px; height:18px; border:3px solid #fff; border-radius:50%; border-top-color:#0066cc; animation:spin 1s linear infinite; vertical-align:middle; margin-left:8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  @media (max-width:720px) { .row { flex-direction:column; } .controls { flex-direction:column; } .summary { flex-direction:column; } }
</style>
</head>
<body>
<div class="wrap">

  <div class="header center">Swamiya Saranam Ayyappa</div>

  <!-- Form -->
  <div class="card">
    <h2 class="center" style="margin:0 0 6px 0;">Sree Sasatha Seva Sangam</h2>

    <label for="name">Name</label>
    <input id="name" type="text" placeholder="Enter name">

    <label for="door">Door No</label>
    <input id="door" type="text" placeholder="Door / Flat no">

    <label for="street">Street Name</label>
    <select id="street">
      <option>Maniyammai Street</option>
      <option>Kozhavizhi Amman 1st Street</option>
      <option>Kozhavizhi Amman 2nd Street</option>
      <option>Kozhavizhi Amman 3rd Street</option>
      <option>Kozhavizhi Amman 4th Street</option>
      <option>Kozhavizhi Amman 5th Street</option>
      <option>MGR Nagar 1st Street</option>
      <option>MGR Nagar 2nd Street</option>
      <option>MGR Nagar 3rd Street</option>
      <option>Govindha Nagar 1st Street</option>
      <option>Govindha Nagar 2nd Street</option>
      <option>Govindha Nagar 3rd Street</option>
    </select>

    <div class="row">
      <div class="col">
        <label for="amount">Amount</label>
        <input id="amount" type="number" min="0" placeholder="Amount (numbers only)">
      </div>
      <div class="col">
        <label for="balance">Balance</label>
        <input id="balance" type="number" min="0" placeholder="Balance (pending)">
      </div>
    </div>

    <label for="date">Date (optional)</label>
    <input id="date" type="date" placeholder="Leave empty to use server date">

    <!-- ✅ Added Mobile Number (only new addition) -->
    <label for="mobile">Mobile Number</label>
    <input id="mobile" type="text" placeholder="Enter mobile number">

    <label>Payment Type</label>
    <div class="payment-box">
      <label class="payment-option"><input type="radio" name="payment" value="GPay"> GPay</label>
      <label class="payment-option"><input type="radio" name="payment" value="Cash"> Cash</label>
    </div>

    <label for="receiver">Receiver Name</label>
    <select id="receiver">
      <option>Gopi</option>
      <option>Mahalingam</option>
      <option>Karthikeyan</option>
      <option<Jaganathan</option>
      <option>Anandhan</option>
      <option>Subramani</option>
      <option>Saravanan</option>
      <option>Manjunathan</option>
    </select>

    <div style="margin-top:12px;">
      <button id="submitBtn" class="btn">Submit</button>
    </div>
  </div>

  <!-- Filter card -->
  <div class="card">
    <h3 style="margin:0 0 8px 0;" class="center">Date Filter & Report</h3>

    <div class="row">
      <div class="col">
        <label for="fromDate">From Date</label>
        <input id="fromDate" type="date">
      </div>
      <div class="col">
        <label for="toDate">To Date</label>
        <input id="toDate" type="date">
      </div>
    </div>

    <div style="margin-top:10px;">
      <label for="filterType">Show</label>
      <select id="filterType">
        <option value="amount">Total Amount</option>
        <option value="pending">Total Pending</option>
      </select>
    </div>

    <div class="controls">
      <div style="flex:1;">
        <button id="filterBtn" class="btn">Get Report</button>
      </div>
      <div id="statusMsg" style="min-width:160px; text-align:right;"></div>
    </div>

    <div class="summary" id="summaryBox" style="display:none;">
      <div class="box"><strong>Total Amount</strong><div id="totalAmount">₹0</div></div>
      <div class="box"><strong>Total Pending</strong><div id="totalPending">₹0</div></div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <button id="downloadBtn" class="btn" style="background:#28a745;">Download Report (CSV)</button>
      <div style="flex:1;"></div>
    </div>

    <div id="tableWrap" style="display:none; margin-top:12px;">
      <table id="resultTable">
        <thead>
          <tr>
            <th>Name</th><th>Door</th><th>Street</th><th>Amount</th><th>Balance</th><th>Payment</th><th>Receiver</th><th>Date</th><th>Mobile</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyw6bKwtI7JtrpR2nSatrHeI44g2UmRhTJR1Olr9u5q8aRNGdklQ7Lp9obnb5EVhkmM0A/exec";

function rupee(x){ return '₹' + Number(x || 0).toLocaleString('en-IN'); }
function esc(s){ if (!s && s !== 0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

const submitBtn = document.getElementById('submitBtn');
const filterBtn = document.getElementById('filterBtn');
const downloadBtn = document.getElementById('downloadBtn');
const statusMsg = document.getElementById('statusMsg');

function setLoading(el, isLoading, text) {
  if (isLoading) {
    el.disabled = true;
    statusMsg.innerHTML = '<span style="color:#666;">' + (text||'Working...') + '</span> <span class="loader"></span>';
  } else {
    el.disabled = false;
    statusMsg.innerHTML = '';
  }
}

let lastFetchedRows = [];

// SUBMIT
submitBtn.addEventListener('click', async () => {
  const name = document.getElementById('name').value.trim();
  const door = document.getElementById('door').value.trim();
  const street = document.getElementById('street').value;
  const amount = document.getElementById('amount').value;
  const balance = document.getElementById('balance').value;
  const dateVal = document.getElementById('date').value;
  const paymentEl = document.querySelector('input[name="payment"]:checked');
  const receiver = document.getElementById('receiver').value;

  // ✅ Read mobile (new)
  const mobile = document.getElementById('mobile').value.trim();

  if (!name || !door || !amount) {
    alert('Please fill Name, Door No and Amount.');
    return;
  }
  if (!paymentEl) {
    alert('Please select Payment Type.');
    return;
  }

  // ✅ mobile added inside payload
  const payload = {
    name: name,
    door: door,
    street: street,
    amount: Number(amount),
    balance: Number(balance || 0),
    payment: paymentEl.value,
    receiver: receiver,
    mobile: mobile
  };
  if (dateVal) payload.date = dateVal;

  try {
    setLoading(submitBtn, true, 'Saving...');
    const res = await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if (data.status === 'duplicate') {
      alert('❗ Record already exists (Name + Door No + Amount).');
    } else if (data.status === 'success') {
      alert('✔ Saved successfully.');
      document.getElementById('name').value = '';
      document.getElementById('door').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('balance').value = '';
      document.getElementById('date').value = '';
      document.getElementById('mobile').value = '';
      document.querySelectorAll('input[name="payment"]').forEach(i=>i.checked=false);
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (from && to) fetchReport(from,to);
    } else {
      alert('Error: ' + (data.message || 'Unknown response'));
    }
  } catch (err) {
    alert('Network or server error.\n' + err);
  } finally {
    setLoading(submitBtn, false);
  }
});

// REPORT
async function fetchReport(from, to) {
  if (!from || !to) { alert('Please select From and To dates.'); return; }

  try {
    setLoading(filterBtn, true, 'Fetching report...');
    const url = scriptURL + '?from=' + encodeURIComponent(from) + '&to=' + encodeURIComponent(to);
    const res = await fetch(url);
    const data = await res.json();
    if (data.status !== 'filter-success') {
      alert('Filter error: ' + (data.message || 'Unknown'));
      return;
    }

    lastFetchedRows = data.rows || [];
    const filterType = document.getElementById('filterType').value;

    let filtered = [];
    let totalAmount = 0;
    let totalPending = 0;

    if (filterType === 'amount') {
      filtered = lastFetchedRows.filter(r => Number(r.balance) >= 0 && Number(r.amount) > 0);
      totalAmount = filtered.reduce((s, r) => s + Number(r.amount), 0);
    } else {
      filtered = lastFetchedRows.filter(r => Number(r.balance) > 0);
      totalPending = filtered.reduce((s, r) => s + Number(r.balance), 0);
    }

    document.getElementById('summaryBox').style.display = 'flex';
    document.getElementById('totalAmount').innerText = rupee(totalAmount || data.totalAmount || 0);
    document.getElementById('totalPending').innerText = rupee(totalPending || data.totalPending || 0);

    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML = '';
    if (filtered.length) {
      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + esc(r.name) + '</td>' +
          '<td>' + esc(r.door) + '</td>' +
          '<td>' + esc(r.street) + '</td>' +
          '<td>' + rupee(r.amount) + '</td>' +
          '<td>' + rupee(r.balance) + '</td>' +
          '<td>' + esc(r.payment) + '</td>' +
          '<td>' + esc(r.receiver) + '</td>' +
          '<td>' + esc(r.date) + '</td>' +
          '<td>' + esc(r.mobile) + '</td>';
        tbody.appendChild(tr);
      });
      document.getElementById('tableWrap').style.display = 'block';
    } else {
      document.getElementById('tableWrap').style.display = 'none';
    }

    if (filterType === 'amount') {
      statusMsg.innerHTML = '<strong>Showing Total Amount (Balance=0 & Amount>0): ' + rupee(totalAmount) + '</strong>';
    } else {
      statusMsg.innerHTML = '<strong>Showing Total Pending (Balance>0): ' + rupee(totalPending) + '</strong>';
    }

  } catch (err) {
    alert('Error fetching report.');
  } finally {
    setLoading(filterBtn, false);
  }
}

filterBtn.addEventListener('click', () => {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  fetchReport(from, to);
});

// DOWNLOAD CSV
downloadBtn.addEventListener('click', () => {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  if (!from || !to) { alert('Select dates first'); return; }

  const filterType = document.getElementById('filterType').value;
  let filtered = [];
  if (filterType === 'amount') {
    filtered = lastFetchedRows.filter(r => Number(r.balance) === 0 && Number(r.amount) > 0);
  } else {
    filtered = lastFetchedRows.filter(r => Number(r.balance) > 0);
  }

  if (!filtered.length) { alert('No rows to download.'); return; }

  const headers = ["Name","Door No","Street","Amount","Balance","Payment","Receiver","Date","Mobile"];
  const rows = filtered.map(r => [
    r.name, r.door, r.street, r.amount, r.balance, r.payment, r.receiver, r.date,r.mobile
  ]);

  const csvContent = [headers].concat(rows).map(e => e.map(cell => {
    if (cell === null || cell === undefined) return '';
    const s = cell.toString();
    if (s.indexOf('"') !== -1 || s.indexOf(',') !== -1 || s.indexOf('\n') !== -1) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }).join(',')).join('\r\n');

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const fname = 'Report_' + from + '_to_' + to + '.csv';
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = fname;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

// INIT
(function init(){
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('fromDate').value = today;
  document.getElementById('toDate').value = today;
  fetchReport(today, today);
})();
</script>
</body>
</html>
